

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testing &mdash; Chanterelle 0.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Deployments" href="deployments.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Chanterelle
          

          
          </a>

          
            
            
              <div class="version">
                0.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chanterelle-json.html">chanterelle.json</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiling.html">Compiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="genesis-blocks.html">Genesis Blocks</a></li>
<li class="toctree-l1"><a class="reference internal" href="libraries.html">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployments.html">Deployments</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Testing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-test-suite">Example Test Suite</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Chanterelle</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Testing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/testing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="testing">
<span id="id1"></span><h1>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>You can use whatever purescript testing framework you want, but for illustrative purposes we will use
<a class="reference external" href="https://github.com/owickstrom/purescript-spec">purescript-spec</a>.</p>
<p>There are various testing utility functions in <code class="docutils literal notranslate"><span class="pre">Chanterelle.Test</span></code>, probably the most important is <code class="docutils literal notranslate"><span class="pre">buildTestConfig</span></code>.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span> <span class="kt">TestConfig</span> <span class="n">r</span> <span class="ow">=</span>
  <span class="p">{</span> <span class="n">accounts</span> <span class="ow">::</span> <span class="kt">Array</span> <span class="kt">Address</span>
  <span class="p">,</span> <span class="n">provider</span> <span class="ow">::</span> <span class="kt">Provider</span>
  <span class="o">|</span> <span class="n">r</span>
  <span class="p">}</span>


<span class="nf">buildTestConfig</span>
  <span class="ow">::</span> <span class="kt">String</span>
  <span class="ow">-&gt;</span> <span class="kt">Int</span>
  <span class="ow">-&gt;</span> <span class="kt">DeployM</span> <span class="n">eff</span> <span class="p">(</span><span class="kt">Record</span> <span class="n">r</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="kt">Aff</span> <span class="p">(</span><span class="n">console</span> <span class="ow">::</span> <span class="kt">CONSOLE</span><span class="p">,</span> <span class="n">eth</span> <span class="ow">::</span> <span class="kt">ETH</span><span class="p">,</span> <span class="n">fs</span> <span class="ow">::</span> <span class="kt">FS</span> <span class="o">|</span> <span class="n">eff</span><span class="p">)</span> <span class="p">(</span><span class="kt">TestConfig</span> <span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
<p>This function takes in some test configuration options and a deploy script, and outputs a record containing all of the unlocked accounts on the test node, a connection to the node, and whatever the output of your deployment script is. This output is then meant to be threaded through as an environment to the rest of your test suites.</p>
<p>Note, unlike the deploy process meant for actual deployments, <code class="docutils literal notranslate"><span class="pre">buildTestConfig</span></code> will not write anything to the file system about the result of your deployment. In other words, test deployments are ephemeral.</p>
</div>
<div class="section" id="example-test-suite">
<h2>Example Test Suite<a class="headerlink" href="#example-test-suite" title="Permalink to this headline">¶</a></h2>
<p>Here’s an example test suite for our <code class="docutils literal notranslate"><span class="pre">SimpleStorage</span></code> contract:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">simpleStorageSpec</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">e</span> <span class="n">r</span><span class="o">.</span>
     <span class="kt">TestConfig</span> <span class="p">(</span><span class="n">simpleStorage</span> <span class="ow">::</span> <span class="kt">Address</span> <span class="o">|</span> <span class="n">r</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="kt">Spec</span> <span class="p">(</span> <span class="n">fs</span> <span class="ow">::</span> <span class="kt">FS</span>
          <span class="p">,</span> <span class="n">eth</span> <span class="ow">::</span> <span class="kt">ETH</span>
          <span class="p">,</span> <span class="n">avar</span> <span class="ow">::</span> <span class="kt">AVAR</span>
          <span class="p">,</span> <span class="n">console</span> <span class="ow">::</span> <span class="kt">CONSOLE</span>
          <span class="o">|</span> <span class="n">e</span>
          <span class="p">)</span> <span class="kt">Unit</span>
<span class="nf">simpleStorageSpec</span> <span class="p">{</span><span class="n">provider</span><span class="p">,</span> <span class="n">accounts</span><span class="p">,</span> <span class="n">simpleStorage</span><span class="p">}</span> <span class="ow">=</span> <span class="kr">do</span>

  <span class="n">describe</span> <span class="s">&quot;Setting the value of a SimpleStorage Contract&quot;</span> <span class="kr">do</span>

    <span class="n">it</span> <span class="s">&quot;can set the value of simple storage&quot;</span> <span class="o">$</span> <span class="kr">do</span>
      <span class="n">var</span> <span class="ow">&lt;-</span> <span class="n">makeEmptyVar</span>
      <span class="kr">let</span> <span class="n">filterCountSet</span> <span class="ow">=</span> <span class="n">eventFilter</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="ow">::</span> <span class="kt">Proxy</span> <span class="kt">SimpleStorage</span><span class="o">.</span><span class="kt">CountSet</span><span class="p">)</span> <span class="n">simpleStorage</span>
      <span class="kr">_</span> <span class="ow">&lt;-</span> <span class="n">forkWeb3</span> <span class="n">provider</span> <span class="o">$</span>
        <span class="n">event</span> <span class="n">filterCountSet</span> <span class="o">$</span> <span class="nf">\</span><span class="n">e</span><span class="o">@</span><span class="p">(</span><span class="kt">SimpleStorage</span><span class="o">.</span><span class="kt">CountSet</span> <span class="n">cs</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
          <span class="n">liftEff</span> <span class="o">$</span> <span class="n">log</span> <span class="o">$</span> <span class="s">&quot;Received Event: &quot;</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">e</span>
          <span class="kr">_</span> <span class="ow">&lt;-</span> <span class="n">liftAff</span> <span class="o">$</span> <span class="n">putVar</span> <span class="n">cs</span><span class="o">.</span><span class="n">_count</span> <span class="n">var</span>
          <span class="n">pure</span> <span class="kt">TerminateEvent</span>
      <span class="kr">let</span> <span class="n">primaryAccount</span> <span class="ow">=</span> <span class="n">unsafePartialBecause</span> <span class="s">&quot;Accounts list has at least one account&quot;</span> <span class="o">$</span> <span class="n">fromJust</span> <span class="p">(</span><span class="n">accounts</span> <span class="o">!!</span> <span class="mi">0</span><span class="p">)</span>
          <span class="n">n</span> <span class="ow">=</span> <span class="n">unsafePartial</span> <span class="n">fromJust</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">uIntNFromBigNumber</span> <span class="n">s256</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">embed</span> <span class="o">$</span> <span class="mi">42</span>
          <span class="n">txOptions</span> <span class="ow">=</span> <span class="n">defaultTransactionOptions</span> <span class="o">#</span> <span class="n">_from</span> <span class="o">?~</span> <span class="n">primaryAccount</span>
                                                <span class="o">#</span> <span class="n">_to</span> <span class="o">?~</span> <span class="n">simpleStorage</span>
                                                <span class="o">#</span> <span class="n">_gas</span> <span class="o">?~</span> <span class="n">embed</span> <span class="mi">90000</span>
      <span class="n">hx</span> <span class="ow">&lt;-</span> <span class="n">assertWeb3</span> <span class="n">provider</span> <span class="o">$</span> <span class="kt">SimpleStorage</span><span class="o">.</span><span class="n">setCount</span> <span class="n">txOptions</span> <span class="p">{</span><span class="n">_count</span><span class="kt">:</span> <span class="n">n</span><span class="p">}</span>
      <span class="n">liftEff</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">log</span> <span class="o">$</span> <span class="s">&quot;setCount tx hash: &quot;</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">hx</span>
      <span class="n">val</span> <span class="ow">&lt;-</span> <span class="n">takeVar</span> <span class="n">var</span>
      <span class="n">val</span> <span class="p">`</span><span class="n">shouldEqual</span><span class="p">`</span> <span class="n">n</span>
</pre></div>
</div>
<p>The flow of the test is as follows:</p>
<ol class="arabic simple">
<li>We create an <code class="docutils literal notranslate"><span class="pre">AVar</span></code> to communicate between the testing thread and the event monitoring thread.</li>
<li>We then fork an event monitoring thread for our <code class="docutils literal notranslate"><span class="pre">CountSet</span></code> event, placing the first received value in the <code class="docutils literal notranslate"><span class="pre">AVar</span></code> and terminating the monitor. Notice that the address for the filter is taken from the supplied <code class="docutils literal notranslate"><span class="pre">TestConfig</span></code>.</li>
<li>We create then our <code class="docutils literal notranslate"><span class="pre">TransactionOptions</span></code> and submit a transaction to change the count using the <code class="docutils literal notranslate"><span class="pre">setCount</span></code> function from the generated PureScript module.</li>
<li>We call <code class="docutils literal notranslate"><span class="pre">takeVar</span></code> which blocks until the var is filled, then make sure the value we received is the one we put in.</li>
</ol>
<p>Admittingly this example is pretty trivial– of course we’re going to get back the value we put in. However, this pattern is pretty universal, namely take the supplied test config to help you template the transactions, call some functions, monitor for some event, then make sure the values are what you want.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="deployments.html" class="btn btn-neutral" title="Deployments" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Martin Allen, Ilya Ostrovskiy.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>